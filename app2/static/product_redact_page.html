<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5">
    <title>Редактировать товар | ELITE</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,400&display=swap"
          rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --bg-gradient-start: #f0f4fe;
            --bg-gradient-end: #e9eefa;
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.4);
            --card-bg: rgba(255, 255, 255, 0.8);
            --primary: #3a56d8;
            --primary-light: #4361ee;
            --primary-deep: #2a41b0;
            --accent: #7b4ee3;
            --text-heading: #131836;
            --text-body: #2b3148;
            --text-muted: #5e657b;
            --border-light: rgba(0, 0, 0, 0.06);
            --shadow-sm: 0 15px 30px -12px rgba(0, 0, 0, 0.05);
            --shadow-hover: 0 24px 44px -16px rgba(26, 47, 105, 0.18);
            --radius-md: 16px;
            --radius-lg: 28px;
            --transition-spring: all 0.35s cubic-bezier(0.22, 1, 0.36, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, 'Segoe UI', sans-serif;
            background: radial-gradient(circle at 20% 30%, #e2eafc, #d9e2f2 90%);
            background-attachment: fixed;
            color: var(--text-body);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 8%;
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(18px) saturate(180%);
            -webkit-backdrop-filter: blur(18px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.5);
            z-index: 100;
            box-shadow: 0 6px 20px -10px rgba(0, 0, 0, 0.02);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: -1px;
            background: linear-gradient(145deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            cursor: pointer;
            transition: var(--transition-spring);
            display: flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
        }

        .logo i {
            font-size: 1.5rem;
            color: var(--primary);
        }

        .nav-links {
            display: flex;
            gap: 12px;
        }

        .nav-link {
            padding: 10px 20px;
            border-radius: 40px;
            border: 1px solid rgba(67, 97, 238, 0.08);
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(6px);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-heading);
            transition: var(--transition-spring);
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .nav-link i {
            color: var(--primary);
        }

        .nav-link:hover {
            background: white;
            border-color: var(--primary-light);
            box-shadow: 0 10px 20px -10px rgba(67, 97, 238, 0.2);
            transform: translateY(-2px);
        }

        .glass-container {
            width: 100%;
            max-width: 560px;
            margin: 80px auto 40px;
            background: var(--glass-bg);
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: 40px 36px;
            box-shadow: var(--shadow-sm);
            transition: var(--transition-spring);
            animation: fadeSlideUp 0.6s ease;
        }

        @keyframes fadeSlideUp {
            0% {
                opacity: 0;
                transform: translateY(24px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .glass-container:hover {
            box-shadow: var(--shadow-hover);
            background: rgba(255, 255, 255, 0.8);
            border-color: rgba(255, 255, 255, 0.8);
        }

        .form-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 28px;
        }

        .form-header i {
            font-size: 2rem;
            color: var(--primary);
            background: rgba(67, 97, 238, 0.12);
            padding: 12px;
            border-radius: 20px;
            backdrop-filter: blur(4px);
        }

        .form-header h2 {
            font-size: 1.9rem;
            font-weight: 700;
            color: var(--text-heading);
            margin: 0;
            letter-spacing: -0.02em;
        }

        .product-image-wrapper {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-bottom: 24px;
        }

        .product-image {
            width: 200px;
            height: 200px;
            border-radius: 24px;
            object-fit: cover;
            border: 1px solid rgba(255, 255, 255, 0.7);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.02);
            transition: var(--transition-spring);
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(4px);
        }

        .product-image:hover {
            transform: scale(1.02);
            box-shadow: var(--shadow-hover);
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 20px;
        }

        label {
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        label i {
            font-size: 0.9rem;
            color: var(--primary-light);
        }

        input[type="text"],
        input[type="number"],
        textarea {
            width: 100%;
            padding: 14px 18px;
            border-radius: 50px;
            border: 1.5px solid rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(4px);
            font-size: 0.98rem;
            font-family: 'Inter', sans-serif;
            color: var(--text-body);
            transition: var(--transition-spring);
            box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.02);
        }

        textarea {
            border-radius: 28px;
            resize: vertical;
            min-height: 120px;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-light);
            background: white;
            box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.08);
        }

        .btn-primary {
            background: linear-gradient(145deg, var(--primary), var(--accent));
            color: white;
            border: none;
            padding: 16px 28px;
            font-size: 1.1rem;
            font-weight: 700;
            border-radius: 60px;
            cursor: pointer;
            transition: var(--transition-spring);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            margin-bottom: 16px;
            box-shadow: 0 16px 28px -10px rgba(67, 97, 238, 0.4);
        }

        .btn-primary i {
            font-size: 1.2rem;
        }

        .btn-primary:hover {
            transform: translateY(-4px);
            box-shadow: 0 24px 38px -10px #3a56d8;
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.15);
            backdrop-filter: blur(8px);
            border: 1.5px solid rgba(239, 68, 68, 0.3);
            color: #b91c1c;
            padding: 16px 24px;
            font-size: 1rem;
            font-weight: 700;
            border-radius: 60px;
            cursor: pointer;
            transition: var(--transition-spring);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
        }

        .btn-danger i {
            color: #b91c1c;
        }

        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.25);
            border-color: #ef4444;
            transform: translateY(-2px);
            box-shadow: 0 12px 24px -10px rgba(239, 68, 68, 0.3);
        }

        .message {
            margin-top: 24px;
            padding: 14px 18px;
            border-radius: 60px;
            font-size: 0.95rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.7);
        }

        .message.success {
            color: #0a7143;
            background: rgba(209, 250, 229, 0.6);
            border-color: #86efac;
        }

        .message.error {
            color: #a13e3e;
            background: rgba(254, 226, 226, 0.6);
            border-color: #fecaca;
        }

        @media (max-width: 600px) {
            body {
                padding: 16px;
                justify-content: flex-start;
            }

            .top-bar {
                padding: 10px 5%;
            }

            .glass-container {
                padding: 28px 20px;
                margin: 90px 0 20px;
                border-radius: 32px;
                max-width: 100%;
            }

            .form-header h2 {
                font-size: 1.6rem;
            }

            .form-header i {
                font-size: 1.6rem;
                padding: 10px;
            }

            .product-image {
                width: 160px;
                height: 160px;
            }

            input[type="text"],
            input[type="number"],
            textarea {
                padding: 16px 20px;
                font-size: 16px;
            }

            .btn-primary,
            .btn-danger {
                padding: 16px 20px;
                font-size: 1rem;
            }
        }

        @media (max-width: 480px) {
            .glass-container {
                padding: 24px 16px;
            }

            .product-image {
                width: 140px;
                height: 140px;
            }
        }
    </style>
</head>
<body>

<div class="top-bar">
    <a href="/main_page" class="logo">
        <i class="fas fa-cube"></i> ELITE
    </a>
    <div class="nav-links">
        <a href="javascript:void(0)" onclick="goToMyProfile()" class="nav-link">
            <i class="fas fa-user-circle"></i> Профиль
        </a>
        <a href="/main_page" class="nav-link">
            <i class="fas fa-store"></i> Каталог
        </a>
    </div>
</div>

<div class="glass-container">
    <div class="form-header">
        <i class="fas fa-edit"></i>
        <h2>Редактировать</h2>
    </div>

    <div class="product-image-wrapper">
        <img id="product-image" class="product-image" src="https://placehold.co/600x600?text=Загрузка..."
             alt="Product Image">
    </div>

    <div class="form-group">
        <label><i class="fas fa-tag"></i> Название товара</label>
        <input type="text" id="title" placeholder="Напр: iPhone 15 Pro" autocomplete="off">
    </div>

    <div class="form-group">
        <label><i class="fas fa-align-left"></i> Описание</label>
        <textarea id="description" placeholder="Опишите ваш товар подробно..."></textarea>
    </div>

    <div class="form-group">
        <label><i class="fas fa-dollar-sign"></i> Цена ($)</label>
        <input type="number" id="price" placeholder="999.99" step="0.01">
    </div>

    <button class="btn-primary" onclick="updateProduct()">
        <i class="fas fa-save"></i> Сохранить изменения
    </button>

    <button class="btn-danger" onclick="deleteProduct()">
        <i class="fas fa-trash-alt"></i> Удалить товар
    </button>

  <div class="message" id="message"></div>
</div>

<script>
const API_URL = "";

let currentProductFullData = null;

function getToken() {
  return localStorage.getItem("access_token");
}

function getProductId() {
  const params = new URLSearchParams(window.location.search);
  return params.get("id");
}

async function goToMyProfile() {
    const token = localStorage.getItem("access_token");
    if (!token) {
        window.location.href = "/login";
        return;
    }
    try {
        const response = await fetch(`${API_URL}/get-current-user`, {
            headers: {"Authorization": `Bearer ${token}`}
        });
        if (!response.ok) throw new Error("Token invalid");
        const data = await response.json();
        window.location.href = `/go-to-profile/${data.id}`;
    } catch (error) {
        console.error("Ошибка:", error);
        window.location.href = "/login";
    }
}

async function loadProduct() {
  const productId = getProductId();
  if (!productId) {
    document.getElementById("message").textContent = "ID товара не найден в URL";
    return;
  }

  try {
    const res = await fetch(`${API_URL}/get-product/${productId}`);
    if (!res.ok) throw new Error("Ошибка при загрузке товара");

    const data = await res.json();
    currentProductFullData = data.product;

    document.getElementById("title").value = currentProductFullData.title || "";
    document.getElementById("description").value = currentProductFullData.description || "";
    document.getElementById("price").value = currentProductFullData.price || "";

    const imgUrl = currentProductFullData.main_url?.startsWith('http')
      ? currentProductFullData.main_url
      : `${API_URL}/${currentProductFullData.main_url?.replace(/^\/+/,'')}`;
      document.getElementById("product-image").src = imgUrl || "https://placehold.co/600x600?text=Нет+фото";

    console.log("Товар успешно загружен во временную память:", currentProductFullData);
  } catch (err) {
    console.error(err);
      const msg = document.getElementById("message");
      msg.textContent = "Ошибка при загрузке данных товара.";
      msg.classList.add("error");
  }
}

async function updateProduct() {
  const messageDiv = document.getElementById("message");
    messageDiv.className = "message";

  if (!currentProductFullData) {
    messageDiv.textContent = "Ошибка: данные товара еще не загружены.";
      messageDiv.classList.add("error");
    return;
  }

  const title = document.getElementById("title").value.trim();
  const description = document.getElementById("description").value.trim();
  const price = parseFloat(document.getElementById("price").value);

  if (!title || !description || isNaN(price)) {
      messageDiv.classList.add("error");
      messageDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Заполните все поля корректно!';
    return;
  }

  const token = getToken();
  if (!token) {
    alert("Ошибка: Вы не авторизованы!");
    return;
  }

  const payload = {
    ...currentProductFullData,
    title: title,
    description: description,
    price: price,
    images: currentProductFullData.images || []
  };

  console.log("Отправка JSON на бэкенд:", payload);

  try {
    const res = await fetch(`${API_URL}/redact-product`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      },
      body: JSON.stringify(payload)
    });

    const resultData = await res.json();

    if (res.ok) {
        messageDiv.classList.add("success");
        messageDiv.innerHTML = '<i class="fas fa-check-circle"></i> Товар успешно обновлён! Переход в профиль...';
      setTimeout(() => {
          window.location.href = "/main_page";
      }, 1000);
    } else {
        messageDiv.classList.add("error");
        messageDiv.innerHTML = `<i class="fas fa-times-circle"></i> ${resultData.detail?.[0]?.msg || resultData.detail || "Ошибка при обновлении"}`;
        console.error("Детали ошибки:", resultData);
    }
  } catch (err) {
    console.error("Сетевая ошибка:", err);
      messageDiv.classList.add("error");
      messageDiv.innerHTML = '<i class="fas fa-wifi-slash"></i> Ошибка связи с сервером.';
  }
}

async function deleteProduct() {
  const productId = getProductId();
  const token = getToken();

  if (!confirm("Вы уверены, что хотите удалить этот товар?")) return;

  try {
    const res = await fetch(`${API_URL}/delete-product/${productId}`, {
      method: "DELETE",
      headers: {
        "Authorization": "Bearer " + token
      }
    });

    if (res.ok) {
      alert("Товар удален");
      window.location.href = "/main_page";
    } else {
      const errorData = await res.json();
      alert("Ошибка при удалении: " + (errorData.detail || "Неизвестная ошибка"));
    }
  } catch (err) {
    console.error("Ошибка сети:", err);
    alert("Ошибка связи с сервером");
  }
}

window.addEventListener("DOMContentLoaded", loadProduct);
</script>

</body>
</html>