<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Elite Shop | Детали товара</title>
<style>
:root {
    --primary: #2563eb;
    --bg: #f8fafc;
    --text: #1e293b;
    --muted: #64748b;
    --secondary: #64748b;
}
body {
    font-family: 'Inter', sans-serif;
    background: var(--bg);
    color: var(--text);
    margin: 0;
    scroll-behavior: smooth;
}
.header {
    position: sticky; top: 0; z-index: 1000;
    background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);
    padding: 10px 5%;
    border-bottom: 1px solid #e2e8f0;
    display: flex; justify-content: space-between; align-items: center;
}
.logo { font-size: 20px; font-weight: 800; color: var(--primary); text-decoration: none; }
.nav-link { text-decoration: none; color: var(--text); font-weight: 600; padding: 6px 12px; border-radius: 8px; font-size: 14px; }

.container {
    max-width: 1300px;
    margin: 20px auto;
    padding: 0 15px;
    box-sizing: border-box;
}
.product-grid {
    display: grid;
    grid-template-columns: 1.2fr 1fr;
    gap: 40px;
    margin-bottom: 40px;
}
.gallery-wrapper {
    display: flex;
    flex-direction: column;
    gap: 15px;
    width: 100%;
}

/* Главный бокс картинки адаптирован под свайп */
.main-img-box {
    background: white;
    border-radius: 20px;
    overflow: hidden;
    width: 100%;
    aspect-ratio: 1 / 1.2; /* Оптимально для мобилок */
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    position: relative;
    touch-action: pan-y; /* Разрешаем вертикальный скролл страницы, но слушаем горизонталь */
}
.main-img-box img { width: 100%; height: 100%; object-fit: cover; }

.thumb-scroll {
    display: flex;
    gap: 10px;
    overflow-x: auto;
    padding: 5px 0;
    scrollbar-width: none; /* Скрываем скроллбар в Firefox */
}
.thumb-scroll::-webkit-scrollbar { display: none; } /* Скрываем скроллбар в Chrome/Safari */

.thumb {
    width: 70px;
    aspect-ratio: 1/1;
    border-radius: 12px;
    cursor: pointer;
    flex-shrink: 0;
    object-fit: cover;
    border: 2px solid transparent;
    transition: 0.2s;
}
.thumb.active { border-color: var(--primary); }

.info { display: flex; flex-direction: column; min-width: 0; }
.info h1 { margin: 0; font-size: 32px; line-height: 1.2; font-weight: 800; }
.price { font-size: 30px; font-weight: 800; color: var(--primary); margin: 15px 0; }

.desc-text { color: var(--muted); line-height: 1.6; font-size: 15px; white-space: pre-line; }
.desc-text.collapsed {
    display: -webkit-box;
    -webkit-line-clamp: 5;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.actions { display: flex; gap: 12px; margin-top: 25px; }

.buy-btn {
    background: var(--primary);
    color: white;
    border: none;
    padding: 16px 20px;
    border-radius: 14px;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    flex: 1.5;
    transition: transform 0.1s active;
}
.seller-btn {
    background: white;
    color: var(--text);
    border: 1px solid #e2e8f0;
    padding: 16px;
    border-radius: 14px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.products-list {
    display: grid;
    grid-template-columns: repeat(2, 1fr); /* 2 колонки на мобилках */
    gap: 15px;
}
.product-card {
    background: white;
    padding: 10px;
    border-radius: 18px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.03);
}
.product-card img { width: 100%; aspect-ratio: 1/1; object-fit: cover; border-radius: 14px; }
.product-card h3 { font-size: 14px; margin: 8px 0 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

#loading-details { position: fixed; inset: 0; background: white; display: flex; justify-content: center; align-items: center; z-index: 2000; }

/* АДАПТАЦИЯ ПОД МОБИЛЬНЫЕ */
@media (max-width: 850px) {
    .header { padding: 10px 15px; }
    .product-grid { grid-template-columns: 1fr; gap: 25px; }
    .info h1 { font-size: 26px; }
    .price { font-size: 24px; margin: 10px 0; }
    .actions { flex-direction: row; } /* Кнопки в ряд для iPhone 16 Pro Max (он широкий) */
}

@media (max-width: 500px) {
    .actions { flex-direction: column; } /* На маленьких телефонах кнопки друг под другом */
    .products-list { grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .product-card { padding: 8px; }
}

@media (min-width: 851px) {
    .products-list { grid-template-columns: repeat(5, 1fr); }
}
</style>
</head>
<body>

<div id="loading-details">Загрузка...</div>

<header class="header">
    <a href="/main_page" class="logo">ELITE SHOP</a>
    <nav style="display:flex; gap:8px;">
        <a href="/go-to-profile" class="nav-link">Профиль</a>
        <a href="/main_page" class="nav-link">Каталог</a>
    </nav>
</header>

<div class="container">
    <div class="product-grid">
        <div class="gallery-wrapper">
            <div class="main-img-box" id="swipe-area">
                <img id="main-img" src="https://placehold.co/600x800?text=Нет+фото" alt="">
            </div>
            <div class="thumb-scroll" id="thumb-container"></div>
        </div>

        <div class="info">
            <h1 id="title">---</h1>
            <div class="price" id="price">$0</div>

            <div class="desc-wrapper">
                <div id="desc" class="desc-text collapsed">---</div>
                <button id="read-more"
                        style="display:none;background:none;border:none;color:var(--primary);cursor:pointer;font-weight:bold;margin:10px 0 20px 0;padding:0; font-size: 14px;">
                    Читать полностью
                </button>
            </div>

            <div class="actions">
                <button class="buy-btn">В корзину</button>
                <button id="seller-profile-btn" class="seller-btn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    Продавец
                </button>
            </div>
        </div>
    </div>

    <hr style="border:0;border-top:1px solid #e2e8f0;margin:40px 0;">
    <h2 style="margin-bottom:20px; font-size: 22px;">Похожие товары</h2>
    <div class="products-list" id="infinite-list"></div>

    <div style="text-align:center; margin-top:30px;">
        <button id="load-more-btn"
                style="padding: 12px 30px;font-size:15px;font-weight:700;border-radius:12px;border:none;cursor:pointer;background:var(--primary);color:white;width: 100%;max-width: 300px;">
            Показать ещё
        </button>
    </div>
</div>

<script>
const API_URL = "http://127.0.0.1:8000";
const PLACEHOLDER_IMG = "https://placehold.co/600x800?text=Нет+фото";
let allImages = [];
let currentIndex = 0;
let autoPlayInterval;
let userTouched = false;

// Для свайпов
let touchStartX = 0;
let touchEndX = 0;

function formatUrl(path) {
    if (!path) return PLACEHOLDER_IMG;
    if (path.startsWith("http")) return path;
    return API_URL + (path.startsWith("/") ? "" : "/") + path;
}

async function init() {
    try {
        const params = new URLSearchParams(window.location.search);
        const productId = params.get("id");

        const response = await fetch(`${API_URL}/get-product/${productId}`);
        const data = await response.json();
        const product = data.product;

        document.getElementById("title").innerText = product.title;
        document.getElementById("price").innerText = `$${product.price}`;

        const sellerBtn = document.getElementById("seller-profile-btn");
        sellerBtn.onclick = () => {
            location.href = `/go-to-profile?id=${product.owner_id}`;
        };

        const descEl = document.getElementById("desc");
        const readMore = document.getElementById("read-more");
        descEl.innerText = product.description || "";

        // Маленький фикс: проверяем высоту после вставки текста
        setTimeout(() => {
            if (descEl.scrollHeight > 120) readMore.style.display = "block";
        }, 100);

        readMore.onclick = () => {
            const collapsed = descEl.classList.toggle("collapsed");
            readMore.innerText = collapsed ? "Читать полностью" : "Скрыть";
        };

        allImages = [];
        if (product.main_url) allImages.push(product.main_url);
        if (product.images && product.images.length) {
            product.images.forEach(img => {
                const url = typeof img === 'string' ? img : img.image_url;
                if (url) allImages.push(url);
            });
        }

        setupGallery();
        setupSwipe(); // Добавляем свайпы
        startAutoPlay();
        loadBottomProducts();
        document.getElementById("loading-details").style.display = "none";
    } catch (e) {
        console.error(e);
        document.getElementById("loading-details").innerText = "Ошибка загрузки";
    }
}

function setupGallery() {
    const container = document.getElementById("thumb-container");
    const main = document.getElementById("main-img");

    main.src = allImages.length ? formatUrl(allImages[0]) : PLACEHOLDER_IMG;
    container.innerHTML = "";

    allImages.forEach((url, i) => {
        const img = document.createElement("img");
        img.src = formatUrl(url);
        img.className = "thumb" + (i === 0 ? " active" : "");
        img.onclick = () => {
            userTouched = true;
            clearInterval(autoPlayInterval);
            selectImage(i);
        };
        container.appendChild(img);
    });
}

function selectImage(index) {
    currentIndex = index;
    const main = document.getElementById("main-img");
    main.src = formatUrl(allImages[index]);

    const thumbs = document.querySelectorAll(".thumb");
    thumbs.forEach((t, i) => t.classList.toggle("active", i === index));

    // Скроллим превьюшки, чтобы активная всегда была видна
    if (thumbs[index]) {
        thumbs[index].scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
    }
}

function setupSwipe() {
    const area = document.getElementById("swipe-area");

    area.addEventListener('touchstart', e => {
        touchStartX = e.changedTouches[0].screenX;
        userTouched = true;
        clearInterval(autoPlayInterval);
    }, false);

    area.addEventListener('touchend', e => {
        touchEndX = e.changedTouches[0].screenX;
        handleGesture();
    }, false);
}

function handleGesture() {
    if (allImages.length < 2) return;
    if (touchStartX - touchEndX > 50) { // Свайп влево -> след. фото
        currentIndex = (currentIndex + 1) % allImages.length;
        selectImage(currentIndex);
    }
    if (touchEndX - touchStartX > 50) { // Свайп вправо -> пред. фото
        currentIndex = (currentIndex - 1 + allImages.length) % allImages.length;
        selectImage(currentIndex);
    }
}

function startAutoPlay() {
    if (allImages.length < 2) return;
    autoPlayInterval = setInterval(() => {
        if (!userTouched) {
            currentIndex = (currentIndex + 1) % allImages.length;
            selectImage(currentIndex);
        }
    }, 5000);
}

let offset = 0;
const limit = 10;

async function loadBottomProducts() {
    try {
        const response = await fetch(`${API_URL}/get-products?offset=${offset}&limit=${limit}`);
        const data = await response.json();
        const list = document.getElementById("infinite-list");
        const products = data.products || data;

        if (!products.length) {
            document.getElementById("load-more-btn").style.display = "none";
            return;
        }

        products.forEach(p => {
            const mainImg = p.main_url ? formatUrl(p.main_url) : PLACEHOLDER_IMG;
            const card = document.createElement("div");
            card.className = "product-card";
            card.onclick = () => location.href = `/product-details?id=${p.id}`;
            card.innerHTML = `
                <img src="${mainImg}" alt="${p.title}">
                <h3 title="${p.title}">${p.title}</h3>
                <div style="color:var(--primary);font-weight:bold;font-size:14px;">$${p.price}</div>
            `;
            list.appendChild(card);
        });

        offset += products.length;
    } catch (e) { console.error(e); }
}

document.getElementById("load-more-btn").onclick = loadBottomProducts;
window.onload = init;
</script>

</body>
</html>