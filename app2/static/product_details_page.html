<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Elite Shop | Детали товара</title>
<style>
:root {
    --primary: #2563eb;
    --bg: #f8fafc;
    --text: #1e293b;
    --muted: #64748b;
}
body {
    font-family: 'Inter', sans-serif;
    background: var(--bg);
    color: var(--text);
    margin: 0;
    scroll-behavior: smooth;
}
.header {
    position: sticky; top: 0; z-index: 1000;
    background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);
    padding: 15px 5%;
    border-bottom: 1px solid #e2e8f0;
    display: flex; justify-content: space-between; align-items: center;
}
.logo { font-size: 22px; font-weight: 800; color: var(--primary); text-decoration: none; }
.nav-link { text-decoration: none; color: var(--text); font-weight: 600; padding: 8px 16px; border-radius: 8px; }
.container {
    max-width: 1300px;
    margin: 40px 0 40px 5%;
    padding: 0 20px;
}
.product-grid {
    display: grid;
    grid-template-columns: 1.2fr 1fr;
    gap: 50px;
    margin-bottom: 80px;
}
.gallery-wrapper { display: flex; flex-direction: column; gap: 20px; }
.main-img-box {
    background: white;
    border-radius: 20px;
    overflow: hidden;
    width: 100%;
    aspect-ratio: 3 / 4;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.05);
}
.main-img-box img { width: 100%; height: 100%; object-fit: cover; }
.thumb-scroll { display: flex; gap: 12px; overflow-x: auto; padding: 10px 0; }
.thumb {
    width: 80px;
    aspect-ratio: 3 / 4;
    border-radius: 8px;
    cursor: pointer;
    flex-shrink: 0;
    object-fit: cover;
    border: 2px solid transparent;
}
.thumb.active { border-color: var(--primary); }
.info { display: flex; flex-direction: column; min-width: 0; }
.info h1 { margin: 0; font-size: 40px; line-height: 1.1; word-wrap: break-word; }
.price { font-size: 36px; font-weight: 800; color: var(--primary); margin: 20px 0; }
.desc-text { color: var(--muted); line-height: 1.6; font-size: 16px; white-space: pre-line; }
.desc-text.collapsed {
    display: -webkit-box;
    -webkit-line-clamp: 6;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
.buy-btn {
    background: var(--primary);
    color: white;
    border: none;
    padding: 20px;
    border-radius: 14px;
    font-size: 18px;
    font-weight: 700;
    cursor: pointer;
    width: fit-content;
    min-width: 250px;
}
.products-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 20px;
}
.product-card {
    background: white;
    padding: 12px;
    border-radius: 16px;
    cursor: pointer;
    transition: 0.2s;
}
.product-card:hover { transform: translateY(-5px); }
.product-card img { width: 100%; aspect-ratio: 3 / 4; object-fit: cover; border-radius: 10px; }
.product-card h3 { font-size: 15px; margin: 8px 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
#loading-details { position: fixed; inset: 0; background: white; display: flex; justify-content: center; align-items: center; z-index: 2000; }
@media (max-width: 850px) {
    .container { margin-left: 0; }
    .product-grid { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<div id="loading-details">Загрузка...</div>

<header class="header">
    <a href="/" class="logo">ELITE SHOP</a>
    <nav><a href="/" class="nav-link">На главную</a></nav>
</header>

<div class="container">
    <div class="product-grid">
        <div class="gallery-wrapper">
            <div class="main-img-box">
                <img id="main-img" src="https://placehold.co/600x800?text=Нет+фото" alt="">
            </div>
            <div class="thumb-scroll" id="thumb-container"></div>
        </div>

        <div class="info">
            <h1 id="title">---</h1>
            <div class="price" id="price">$0</div>

            <div class="desc-wrapper">
                <div id="desc" class="desc-text collapsed">---</div>
                <button id="read-more"
                        style="display:none;background:none;border:none;color:var(--primary);cursor:pointer;font-weight:bold;margin:10px 0 30px 0;padding:0;">
                    Читать полностью
                </button>
            </div>

            <button class="buy-btn">Добавить в корзину</button>
        </div>
    </div>

    <hr style="border:0;border-top:1px solid #e2e8f0;margin:60px 0;">
    <h2 style="margin-bottom:30px;">Другие товары</h2>
    <div class="products-list" id="infinite-list"></div>

    <div style="text-align:center; margin-top:40px;">
        <button id="load-more-btn"
                style="padding: 14px 40px;font-size:16px;font-weight:700;border-radius:12px;border:none;cursor:pointer;background:var(--primary);color:white;">
            Показать ещё
        </button>
    </div>
</div>

<script>
const API_URL = "http://127.0.0.1:8000";
const PLACEHOLDER_IMG = "https://placehold.co/600x800?text=Нет+фото";
let allImages = [];
let currentIndex = 0;
let autoPlayInterval;
let userTouched = false;

function formatUrl(path) {
    if (!path) return PLACEHOLDER_IMG;
    if (path.startsWith("http")) return path;
    return API_URL + (path.startsWith("/") ? "" : "/") + path;
}

async function init() {
    const params = new URLSearchParams(window.location.search);
    const productId = params.get("id");

    const response = await fetch(`${API_URL}/get-product/${productId}`);
    const data = await response.json();
    const product = data.product;

    document.getElementById("title").innerText = product.title;
    document.getElementById("price").innerText = `$${product.price}`;

    const descEl = document.getElementById("desc");
    const readMore = document.getElementById("read-more");
    descEl.innerText = product.description || "";
    if (descEl.scrollHeight > 150) readMore.style.display = "block";

    readMore.onclick = () => {
        const collapsed = descEl.classList.toggle("collapsed");
        readMore.innerText = collapsed ? "Читать полностью" : "Скрыть";
    };

    allImages = [];
    if (product.main_url) allImages.push(product.main_url);
    if (product.images && product.images.length) {
        product.images.forEach(img => {
            if (img.image_url) allImages.push(img.image_url);
        });
    }

    setupGallery();
    startAutoPlay();
    loadBottomProducts();
    document.getElementById("loading-details").style.display = "none";
}

function setupGallery() {
    const container = document.getElementById("thumb-container");
    const main = document.getElementById("main-img");

    main.src = allImages.length ? formatUrl(allImages[0]) : PLACEHOLDER_IMG;
    main.onerror = () => { main.src = PLACEHOLDER_IMG; };

    container.innerHTML = "";

    allImages.forEach((url, i) => {
        const img = document.createElement("img");
        img.src = formatUrl(url);
        img.onerror = () => { img.src = PLACEHOLDER_IMG; };
        img.className = "thumb" + (i === 0 ? " active" : "");
        img.onclick = () => { userTouched = true; clearInterval(autoPlayInterval); selectImage(i); };
        container.appendChild(img);
    });
}

function selectImage(index) {
    currentIndex = index;
    const main = document.getElementById("main-img");
    main.src = allImages.length ? formatUrl(allImages[index]) : PLACEHOLDER_IMG;
    main.onerror = () => { main.src = PLACEHOLDER_IMG; };
    document.querySelectorAll(".thumb").forEach((t, i) =>
        t.classList.toggle("active", i === index)
    );
}

function startAutoPlay() {
    if (allImages.length < 2) return;
    autoPlayInterval = setInterval(() => {
        if (!userTouched) {
            currentIndex = (currentIndex + 1) % allImages.length;
            selectImage(currentIndex);
        }
    }, 4000);
}

let offset = 0;
const limit = 10;

async function loadBottomProducts() {
    try {
        const response = await fetch(`${API_URL}/get-products?offset=${offset}&limit=${limit}`);
        const data = await response.json();
        const list = document.getElementById("infinite-list");
        const products = data.products || data;

        if (!products.length) {
            document.getElementById("load-more-btn").style.display = "none";
            return;
        }

        products.forEach(p => {
            const mainImg = p.main_url ? formatUrl(p.main_url) : (p.images?.[0]?.image_url ? formatUrl(p.images[0].image_url) : PLACEHOLDER_IMG);
            const img = document.createElement("img");
            img.src = mainImg;
            img.onerror = () => { img.src = PLACEHOLDER_IMG; };

            const card = document.createElement("div");
            card.className = "product-card";
            card.onclick = () => location.href = `/product-details?id=${p.id}`;
            card.innerHTML = `
                <img src="${mainImg}" alt="${p.title}">
                <h3 title="${p.title}">${p.title}</h3>
                <div style="color:var(--primary);font-weight:bold;">$${p.price}</div>
            `;
            list.appendChild(card);
        });

        offset += products.length;
    } catch (e) { console.error("Ошибка при подгрузке товаров:", e); }
}

document.getElementById("load-more-btn").onclick = loadBottomProducts;
window.onload = init;
</script>

</body>
</html>
